generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id            String    @id @default(cuid())
  name          String
  email         String?   @unique
  emailVerified DateTime? @map("email_verified")
  image         String?
  phone         String?
  pinHash       String?   @map("pin_hash") // Optional: set after OAuth
  mustChangePin Boolean   @default(true) @map("must_change_pin") // Force PIN change on first login
  role          String    @default("EMPLOYEE") // OWNER | EMPLOYEE
  avatar        String?
  createdAt     DateTime  @default(now()) @map("created_at")

  // Auth.js relations
  accounts Account[]
  sessions Session[]

  // App relations
  sales          Sale[]
  expenses       Expense[]
  stockMovements StockMovement[]

  @@map("users")
}

// Auth.js required models
model Account {
  id                String  @id @default(cuid())
  userId            String  @map("user_id")
  type              String
  provider          String
  providerAccountId String  @map("provider_account_id")
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model Product {
  id             Int       @id @default(autoincrement())
  name           String
  price          Int       // Stored in GNF
  priceBuy       Int?      @map("price_buy")
  stock          Int       @default(0)
  minStock       Int       @default(10) @map("stock_min")
  category       String?   // Product category
  expirationDate DateTime? @map("expiration_date") // Expiration tracking (deprecated - use batches)
  lotNumber      String?   @map("lot_number") // Batch/lot tracking (deprecated - use batches)
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  // Relations
  batches          ProductBatch[]
  saleItems        SaleItem[]
  stockMovements   StockMovement[]
  productSuppliers ProductSupplier[]

  @@map("products")
}

// ============================================================================
// FEFO Batch Tracking (Phase 3)
// ============================================================================

model ProductBatch {
  id              Int       @id @default(autoincrement())
  productId       Int       @map("product_id")
  lotNumber       String    @map("lot_number")         // e.g., "LOT-2024-001"
  expirationDate  DateTime  @map("expiration_date")    // e.g., "2026-12-31"
  quantity        Int       @default(0)                // Current quantity in this batch
  initialQty      Int       @map("initial_qty")        // Original quantity received
  unitCost        Int?      @map("unit_cost")          // Cost per unit (optional)
  supplierOrderId Int?      @map("supplier_order_id")  // Link to supplier order
  receivedDate    DateTime  @default(now()) @map("received_date")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  product         Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  saleItems       SaleItem[]

  @@index([productId])
  @@index([expirationDate])
  @@index([quantity])
  @@map("product_batches")
}

model Sale {
  id              Int       @id @default(autoincrement())
  total           Int
  paymentMethod   String    @map("payment_method") // CASH | ORANGE_MONEY | CREDIT
  paymentStatus   String    @default("PAID") @map("payment_status") // PAID | PENDING | PARTIAL
  paymentRef      String?   @map("payment_ref")
  amountPaid      Int       @default(0) @map("amount_paid")
  amountDue       Int       @default(0) @map("amount_due")
  dueDate         DateTime? @map("due_date")
  customerName    String?   @map("customer_name")
  customerPhone   String?   @map("customer_phone")
  createdAt       DateTime  @default(now()) @map("created_at")
  userId          String    @map("user_id")
  modifiedAt      DateTime? @map("modified_at")
  modifiedBy      String?   @map("modified_by")
  editCount       Int       @default(0) @map("edit_count")

  // Relations
  user            User             @relation(fields: [userId], references: [id])
  items           SaleItem[]
  creditPayments  CreditPayment[]

  @@map("sales")
}

model SaleItem {
  id             Int   @id @default(autoincrement())
  saleId         Int   @map("sale_id")
  productId      Int   @map("product_id")
  productBatchId Int?  @map("product_batch_id") // Optional: which batch was sold (FEFO tracking)
  quantity       Int
  unitPrice      Int   @map("unit_price")
  subtotal       Int

  // Relations
  sale         Sale          @relation(fields: [saleId], references: [id], onDelete: Cascade)
  product      Product       @relation(fields: [productId], references: [id])
  productBatch ProductBatch? @relation(fields: [productBatchId], references: [id])

  @@map("sale_items")
}

model CreditPayment {
  id          Int       @id @default(autoincrement())
  saleId      Int       @map("sale_id")
  amount      Int
  method      String    // CASH | ORANGE_MONEY
  reference   String?
  notes       String?
  createdAt   DateTime  @default(now()) @map("created_at")
  recordedBy  String    @map("recorded_by")

  // Relations
  sale        Sale      @relation(fields: [saleId], references: [id], onDelete: Cascade)

  @@map("credit_payments")
}

model Expense {
  id          Int       @id @default(autoincrement())
  amount      Int
  category    String    // STOCK_PURCHASE | RENT | SALARY | ELECTRICITY | TRANSPORT | OTHER
  description String
  date        DateTime  @default(now())
  createdAt   DateTime  @default(now()) @map("created_at")
  userId      String    @map("user_id")

  // Relations
  user        User      @relation(fields: [userId], references: [id])

  @@map("expenses")
}

model StockMovement {
  id             Int       @id @default(autoincrement())
  productId      Int       @map("product_id")
  type           String    // SALE | SALE_EDIT | ADJUSTMENT | INVENTORY | DAMAGED | EXPIRED
  quantityChange Int       @map("quantity_change") // Can be negative
  reason         String?
  createdAt      DateTime  @default(now()) @map("created_at")
  userId         String    @map("user_id")

  // Relations
  product        Product   @relation(fields: [productId], references: [id])
  user           User      @relation(fields: [userId], references: [id])

  @@map("stock_movements")
}

// ============================================================================
// Supplier Management Models
// ============================================================================

model Supplier {
  id               Int       @id @default(autoincrement())
  name             String
  phone            String?
  paymentTermsDays Int       @default(30) @map("payment_terms_days")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  // Relations
  orders           SupplierOrder[]
  returns          SupplierReturn[]
  productSuppliers ProductSupplier[]

  @@map("suppliers")
}

model SupplierOrder {
  id              Int       @id @default(autoincrement())
  supplierId      Int       @map("supplier_id")
  type            String    @default("ORDER") // ORDER | RETURN
  orderDate       DateTime  @default(now()) @map("order_date") // For returns, this is submission date
  deliveryDate    DateTime? @map("delivery_date")
  totalAmount     Int       @map("total_amount") // Total in GNF
  calculatedTotal Int?      @map("calculated_total") // Calculated from items
  amountPaid      Int       @default(0) @map("amount_paid") // For orders: paid amount; for returns: refunded amount
  dueDate         DateTime  @map("due_date") // For orders: payment due date
  status          String    @default("PENDING") // PENDING | DELIVERED | CANCELLED
  paymentStatus   String    @default("PENDING") // PENDING | PAID | UNPAID - for returns, tracks refund status
  cancelledAt     DateTime? @map("cancelled_at")
  notes           String?
  // Return-specific fields (only used when type === 'RETURN')
  returnReason    String?   @map("return_reason") // EXPIRING | DAMAGED | OTHER
  returnProductId Int?      @map("return_product_id") // Product being returned (for single-product returns)
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  supplier        Supplier            @relation(fields: [supplierId], references: [id])
  items           SupplierOrderItem[]
  appliedReturns  SupplierReturn[]    @relation("AppliedToOrder")

  @@index([type])
  @@index([paymentStatus])
  @@map("supplier_orders")
}

model SupplierOrderItem {
  id               Int       @id @default(autoincrement())
  orderId          Int       @map("order_id")
  productId        Int?      @map("product_id") // Null if new product not yet created
  productName      String    @map("product_name")
  category         String?   // Category for new products
  quantity         Int       // Ordered quantity
  quantityReceived Int?      @map("quantity_received") // Received quantity (for delivery confirmation)
  unitPrice        Int       @map("unit_price")
  subtotal         Int
  notes            String?
  createdAt        DateTime  @default(now()) @map("created_at")

  // Relations
  order            SupplierOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@map("supplier_order_items")
}

model ProductSupplier {
  id                  Int       @id @default(autoincrement())
  productId           Int       @map("product_id")
  supplierId          Int       @map("supplier_id")
  supplierProductCode String?   @map("supplier_product_code")
  supplierProductName String?   @map("supplier_product_name")
  defaultPrice        Int?      @map("default_price")
  isPrimary           Boolean   @default(false) @map("is_primary")
  lastOrderedDate     DateTime? @map("last_ordered_date")
  createdAt           DateTime  @default(now()) @map("created_at")

  // Relations
  product             Product   @relation(fields: [productId], references: [id])
  supplier            Supplier  @relation(fields: [supplierId], references: [id])

  @@unique([productId, supplierId])
  @@map("product_suppliers")
}

model SupplierReturn {
  id               Int       @id @default(autoincrement())
  supplierId       Int       @map("supplier_id")
  supplierOrderId  Int?      @map("supplier_order_id") // Optional link for deduction
  productId        Int       @map("product_id")
  quantity         Int
  reason           String    // EXPIRED | DAMAGED | WRONG_PRODUCT | QUALITY_ISSUE | OTHER
  creditAmount     Int       @map("credit_amount")
  returnDate       DateTime  @default(now()) @map("return_date")
  applied          Boolean   @default(false) // Credit applied to payment
  appliedToOrderId Int?      @map("applied_to_order_id")
  createdAt        DateTime  @default(now()) @map("created_at")

  // Relations
  supplier         Supplier       @relation(fields: [supplierId], references: [id])
  appliedToOrder   SupplierOrder? @relation("AppliedToOrder", fields: [appliedToOrderId], references: [id])

  @@map("supplier_returns")
}

// ============================================================================
// Sync Infrastructure Models
// ============================================================================

// ðŸ†• Idempotency key tracking - prevents duplicate transactions on retry
model SyncIdempotencyKey {
  id             String   @id @default(cuid())
  idempotencyKey String   @unique @map("idempotency_key")
  entityType     String   @map("entity_type") // SALE | EXPENSE | PRODUCT | STOCK_MOVEMENT | etc.
  entityId       Int      @map("entity_id") // Server ID of created/updated entity
  createdAt      DateTime @default(now()) @map("created_at")
  expiresAt      DateTime @map("expires_at") // Auto-cleanup after 24 hours

  @@index([idempotencyKey])
  @@index([expiresAt])
  @@map("sync_idempotency_keys")
}
